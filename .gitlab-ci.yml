image: "mahieronymus/ad_sensitivity:2.03"

stages:
 - Static Analysis Python
 - Static Analysis CPP
 - build
 - test

black:
  stage: Static Analysis Python
  script:
    - black --check scripts/
  allow_failure: false
  tags:
    - style

lint:
  stage: Static Analysis CPP
  script:
    - cpplint --linelength=120 --quiet --counting=toplevel --filter=-build/include_subdir,-readability/fn_size,-legal/copyright,-runtime/references,-runtime/arrays --recursive --exclude=src/scratch/*.cpp --exclude=build/* .
  tags:
    - style
  allow_failure: false

build:
  stage: build
  artifacts:
    untracked: true
  script:
    - cd exe_scripts && ./make_script_docker.sh
  tags:
    - make
  allow_failure: false

test:
  stage: test
  dependencies:
    - build
  script:
    - cd exe_scripts && ./docker_test.sh
    - cd ../scripts && python3 test_output.py --input ../data/test_files_simulated/ --test_nan_dims --test_physics ../build_interface/lib/libpython_interface.so --verbosity 3
  tags:
    - test
  allow_failure: false